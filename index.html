<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOSSJSS Sudoku Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', sans-serif; box-sizing: border-box; }
        .sudoku-grid { display: grid; grid-template-columns: repeat(9, 1fr); background-color: #1e3a8a; border: 3px solid #1e3a8a; gap: 1px; border-radius: 8px; overflow: hidden; }
        .sudoku-cell { width: 100%; aspect-ratio: 1/1; text-align: center; background: white; font-size: 1.5rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; position: relative; }
        
        /* é¸ä¸­ç‹€æ…‹ï¼šæ›´æ˜é¡¯çš„è—è‰²å¤–æ¡† */
        .sudoku-cell.selected { background: #eff6ff !important; outline: 3px solid #3b82f6; z-index: 10; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .sudoku-cell.preset { background: #f8fafc; color: #1e40af; font-weight: 800; cursor: not-allowed; }
        .sudoku-cell:not(.preset):hover { background: #f1f5f9; }

        /* 3x3 ç²—ç·šæ¢ */
        .border-r-thick { border-right: 3px solid #1e3a8a !important; }
        .border-b-thick { border-bottom: 3px solid #1e3a8a !important; }
        
        .numpad-btn { background: white; border: 1px solid #e2e8f0; border-radius: 12px; font-weight: 700; font-size: 1.25rem; height: 60px; transition: all 0.2s; color: #1e40af; }
        .numpad-btn:active { transform: scale(0.95); background: #3b82f6; color: white; }
    </style>
</head>
<body class="h-full bg-slate-50 text-slate-900">

    <div id="app" class="max-w-xl mx-auto min-h-full p-4 flex flex-col">
        
        <header class="text-center py-8">
            <h1 class="text-4xl font-black text-blue-900 tracking-tight mb-1">MOSSJSS Sudoku</h1>
            <div class="inline-block px-4 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-bold">Level 2 Data System</div>
        </header>

        <main id="reg-screen" class="bg-white p-8 rounded-[2rem] shadow-2xl border border-blue-50">
            <h2 class="text-xl font-bold mb-6 text-slate-800 flex items-center gap-2">
                <span class="w-2 h-6 bg-blue-600 rounded-full"></span> å­¸ç”Ÿè³‡æ–™ç™»è¨˜
            </h2>
            <form id="reg-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-slate-500 mb-2 ml-1">å§“å Name</label>
                    <input type="text" id="name" required class="w-full px-5 py-4 bg-slate-50 border-0 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none text-lg font-medium" placeholder="è¼¸å…¥å§“å">
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-500 mb-2 ml-1">å¹´ç´š Form</label>
                        <select id="year" class="w-full px-4 py-4 bg-slate-50 border-0 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">é¸æ“‡</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-500 mb-2 ml-1">ç­åˆ¥ Class</label>
                        <select id="section" class="w-full px-4 py-4 bg-slate-50 border-0 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">é¸æ“‡</option>
                            <option>A</option><option>G</option><option>L</option><option>S</option><option>B</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-500 mb-2 ml-1">åº§è™Ÿ No.</label>
                        <select id="num" class="w-full px-4 py-4 bg-slate-50 border-0 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500" required></select>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-5 rounded-2xl transition-all shadow-lg shadow-blue-200 text-lg">ğŸ¯ é€²å…¥æŒ‘æˆ°</button>
            </form>
            <button id="goto-rank" class="w-full mt-8 text-slate-400 hover:text-blue-600 text-sm font-medium transition italic">ğŸ† æŸ¥çœ‹æ­·å²æˆç¸¾</button>
        </main>

        <main id="game-screen" class="hidden">
            <div class="bg-white p-5 rounded-[2rem] shadow-2xl border border-blue-50">
                <div class="flex justify-between items-end mb-6 px-2">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Player</p>
                        <span id="p-name" class="font-black text-xl text-blue-900"></span>
                    </div>
                    <div class="text-right">
                        <div id="timer-display" class="text-3xl font-mono font-black text-blue-600 bg-blue-50 px-4 py-1 rounded-xl">00:00</div>
                    </div>
                </div>

                <div id="grid" class="sudoku-grid mb-8"></div>

                <div id="numpad" class="grid grid-cols-5 gap-3 mb-6">
                    </div>

                <div id="msg" class="hidden mb-6 p-4 rounded-2xl text-center font-bold animate-bounce"></div>

                <div class="flex gap-4">
                    <button id="submit" class="hidden flex-1 bg-green-600 text-white py-5 rounded-2xl font-bold text-xl shadow-lg shadow-green-100">ğŸ† æäº¤æˆç¸¾</button>
                    <button id="admin-btn" class="text-slate-200 hover:text-slate-400 transition">âš™ï¸</button>
                </div>
            </div>
        </main>

        <main id="rank-screen" class="hidden">
            <div class="bg-white p-8 rounded-[2rem] shadow-2xl border border-blue-50">
                <h2 class="text-2xl font-black text-slate-800 mb-8 text-center italic">Leaderboard</h2>
                <div class="overflow-hidden rounded-2xl border border-slate-100 mb-8">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-400 font-bold">
                            <tr>
                                <th class="px-6 py-4">STUDENT</th>
                                <th class="px-6 py-4">TIME</th>
                            </tr>
                        </thead>
                        <tbody id="rank-tbody" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
                <button onclick="location.reload()" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-bold shadow-xl">è¿”å›é¦–é </button>
            </div>
        </main>
    </div>

    <script>
        const PUZZLE = "530070000600195000098000060800060003400803001700020006060000280000419005000080079";
        const SOLUTION = "534678912672195348198342567859761423426853791713924856961537284287419635345286179";

        let seconds = 0, interval, selected = null;
        let player = {};
        let database = JSON.parse(localStorage.getItem('mossjss_records') || '[]');

        const numDropdown = document.getElementById('num');
        for(let i=1; i<=35; i++) numDropdown.add(new Option(i, i));

        function switchScreen(id) {
            ['reg-screen', 'game-screen', 'rank-screen'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function initGame() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for(let i=0; i<81; i++) {
                const cell = document.createElement('div');
                cell.className = 'sudoku-cell';
                const row = Math.floor(i/9), col = i%9;
                if(col === 2 || col === 5) cell.classList.add('border-r-thick');
                if(row === 2 || row === 5) cell.classList.add('border-b-thick');

                if(PUZZLE[i] !== '0') {
                    cell.textContent = PUZZLE[i];
                    cell.classList.add('preset');
                } else {
                    cell.onclick = (e) => {
                        e.stopPropagation();
                        if(selected) selected.classList.remove('selected');
                        selected = cell;
                        cell.classList.add('selected');
                    };
                }
                cell.id = `c-${i}`;
                grid.appendChild(cell);
            }

            // ç”Ÿæˆæ•¸å­—æŒ‰éˆ• (1-9 å’Œ æ¸…é™¤)
            const pad = document.getElementById('numpad');
            pad.innerHTML = '';
            for(let i=1; i<=9; i++) {
                const b = document.createElement('button');
                b.className = 'numpad-btn shadow-sm hover:shadow-md';
                b.textContent = i;
                b.onclick = () => fillNumber(i);
                pad.appendChild(b);
            }
            const clearBtn = document.createElement('button');
            clearBtn.className = 'numpad-btn bg-slate-50 text-slate-400 col-span-1';
            clearBtn.textContent = 'âŒ«';
            clearBtn.onclick = () => fillNumber("");
            pad.appendChild(clearBtn);
        }

        // å¡«å…¥æ•¸å­—çš„çµ±ä¸€å‡½æ•¸
        function fillNumber(num) {
            if(selected && !selected.classList.contains('preset')) {
                selected.textContent = num;
                validate();
            }
        }

        // --- æ”¯æ´éµç›¤è¼¸å…¥ ---
        document.addEventListener('keydown', (e) => {
            if(e.key >= 1 && e.key <= 9) {
                fillNumber(e.key);
            } else if(e.key === "Backspace" || e.key === "Delete" || e.key === "0") {
                fillNumber("");
            }
        });

        // é»æ“Šç©ºç™½è™•å–æ¶ˆé¸å–
        document.onclick = () => {
            if(selected) {
                selected.classList.remove('selected');
                selected = null;
            }
        };

        function validate() {
            let current = "";
            for(let i=0; i<81; i++) current += document.getElementById(`c-${i}`).textContent || "0";
            const msg = document.getElementById('msg');
            if(!current.includes("0")) {
                if(current === SOLUTION) {
                    clearInterval(interval);
                    msg.innerHTML = "âœ¨ PERFECT! å®Œç¾å®Œæˆ";
                    msg.className = "mb-6 p-4 rounded-2xl text-center font-bold bg-green-100 text-green-700 block";
                    document.getElementById('submit').classList.remove('hidden');
                } else {
                    msg.textContent = "âŒ æœ‰äº›æ•¸å­—ä¸æ­£ç¢ºï¼Œå†æª¢æŸ¥ä¸€ä¸‹ï¼";
                    msg.className = "mb-6 p-4 rounded-2xl text-center font-bold bg-red-100 text-red-600 block";
                }
            }
        }

        document.getElementById('reg-form').onsubmit = (e) => {
            e.preventDefault();
            player = {
                name: document.getElementById('name').value.trim(),
                year: document.getElementById('year').value,
                section: document.getElementById('section').value,
                num: document.getElementById('num').value
            };
            document.getElementById('p-name').textContent = `${player.name} (${player.year}${player.section})`;
            initGame();
            switchScreen('game-screen');
            interval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds/60).toString().padStart(2,'0');
                const s = (seconds%60).toString().padStart(2,'0');
                document.getElementById('timer-display').textContent = `${m}:${s}`;
            }, 1000);
        };

        // æäº¤è‡³ Google Form
        document.getElementById('submit').onclick = () => {
            const finalTimeStr = document.getElementById('timer-display').textContent;
            const now = new Date().toLocaleString('zh-TW');

            const formID = "1FAIpQLSfkleuXoAlsbivdiWNYzriMBHcB4HGD_DJYWFvZmTNGvbrKnw";
            const entryIDs = {
                name: "entry.701487326",
                year: "entry.952790733",
                section: "entry.1021343510",
                num: "entry.1352470273",
                seconds: "entry.1466910873",
                timeStr: "entry.258411986",
                timestamp: "entry.1372524630"
            };

            const baseURL = `https://docs.google.com/forms/d/e/${formID}/formResponse`;
            const params = new URLSearchParams();
            params.append(entryIDs.name, player.name);
            params.append(entryIDs.year, player.year);
            params.append(entryIDs.section, player.section);
            params.append(entryIDs.num, player.num);
            params.append(entryIDs.seconds, seconds);
            params.append(entryIDs.timeStr, finalTimeStr);
            params.append(entryIDs.timestamp, now);

            fetch(baseURL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: params.toString() })
            .then(() => {
                alert("ğŸ† æˆç¸¾å·²ä¸Šå‚³ï¼");
                const record = { ...player, total_seconds: seconds, time_formatted: finalTimeStr, timestamp: now };
                database.push(record);
                database.sort((a,b) => a.total_seconds - b.total_seconds);
                localStorage.setItem('mossjss_records', JSON.stringify(database));
                renderRanks();
                switchScreen('rank-screen');
            });
        };

        function renderRanks() {
            const body = document.getElementById('rank-tbody');
            body.innerHTML = database.slice(0, 10).map((r) => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800">${r.name}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">${r.year}${r.section} Â· NO.${r.num}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-blue-600 font-mono font-black text-lg">${r.time_formatted}</div>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('goto-rank').onclick = () => { renderRanks(); switchScreen('rank-screen'); };
        
        // --- Debug å®‰å…¨é– ---
        document.getElementById('admin-btn').onclick = () => {
            const pw = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
            if(pw === "83745189") {
                for(let i=0; i<81; i++) {
                    const c = document.getElementById(`c-${i}`);
                    if(!c.classList.contains('preset')) c.textContent = SOLUTION[i];
                }
                validate();
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        };
    </script>
</body>
</html>
