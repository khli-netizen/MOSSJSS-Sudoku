<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOSSJSS Sudoku Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans TC', sans-serif; box-sizing: border-box; touch-action: manipulation; }
        
        /* æ•¸ç¨å®¹å™¨ï¼šç¢ºä¿åœ¨å°è¢å¹•ä¸æœƒæº¢å‡º */
        .sudoku-container {
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
        }

        .sudoku-grid { 
            display: grid; 
            grid-template-columns: repeat(9, 1fr); 
            background-color: #1e3a8a; 
            border: 2px solid #1e3a8a; 
            gap: 1px; 
            border-radius: 4px; 
            overflow: hidden;
            width: 100%;
        }

        .sudoku-cell { 
            width: 100%; 
            aspect-ratio: 1/1; 
            text-align: center; 
            background: white; 
            font-size: clamp(1rem, 5vw, 1.5rem); /* å­—é«”éš¨è¢å¹•å¤§å°ç¸®æ”¾ */
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.1s; 
            position: relative; 
        }
        
        .sudoku-cell.selected { background: #dbeafe !important; box-shadow: inset 0 0 0 3px #3b82f6; z-index: 5; }
        .sudoku-cell.preset { background: #f8fafc; color: #1e40af; font-weight: 800; }

        /* 3x3 ç²—ç·šï¼šæ‰‹æ©Ÿä¸Šç¨å¾®èª¿ç´°ä¸€é»é»é¿å…ä½”ç©ºé–“ */
        .border-r-thick { border-right: 2px solid #1e3a8a !important; }
        .border-b-thick { border-bottom: 2px solid #1e3a8a !important; }
        
        .numpad-btn { 
            background: white; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            font-weight: 700; 
            font-size: 1.2rem; 
            height: 50px; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s, background 0.1s;
        }
        .numpad-btn:active { background: #3b82f6; color: white; transform: scale(0.95); }
    </style>
</head>
<body class="h-full bg-slate-50 text-slate-900">

    <div id="app" class="max-w-xl mx-auto min-h-full p-2 sm:p-4 flex flex-col">
        
        <header class="text-center py-4 sm:py-6">
            <h1 class="text-3xl font-black text-blue-900 tracking-tight">MOSSJSS Sudoku</h1>
            <p class="text-blue-600 text-xs font-bold uppercase tracking-widest">Level 2 Challenge</p>
        </header>

        <main id="reg-screen" class="bg-white p-6 sm:p-8 rounded-[2rem] shadow-xl border border-blue-50 mx-2">
            <form id="reg-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">å§“å Name</label>
                    <input type="text" id="name" required class="w-full px-4 py-3 bg-slate-50 border-0 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-medium" placeholder="è¼¸å…¥å§“å">
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">å¹´ç´š</label>
                        <select id="year" class="w-full px-2 py-3 bg-slate-50 border-0 rounded-xl outline-none" required>
                            <option value="">é¸</option><option>F1</option><option>F2</option><option>F3</option><option>F4</option><option>F5</option><option>F6</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">ç­åˆ¥</label>
                        <select id="section" class="w-full px-2 py-3 bg-slate-50 border-0 rounded-xl outline-none" required>
                            <option value="">é¸</option><option>A</option><option>G</option><option>L</option><option>S</option><option>B</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">åº§è™Ÿ</label>
                        <select id="num" class="w-full px-2 py-3 bg-slate-50 border-0 rounded-xl outline-none" required></select>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition">é–‹å§‹æŒ‘æˆ°</button>
            </form>
            <button id="goto-rank" class="w-full mt-6 text-slate-400 text-xs font-medium italic">ğŸ† æŸ¥çœ‹æˆç¸¾è¨˜éŒ„</button>
        </main>

        <main id="game-screen" class="hidden px-2">
            <div class="bg-white p-3 sm:p-5 rounded-[2rem] shadow-xl">
                <div class="flex justify-between items-center mb-4 px-1">
                    <span id="p-name" class="font-bold text-blue-900 truncate max-w-[150px]"></span>
                    <div id="timer-display" class="text-xl font-mono font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-lg">00:00</div>
                </div>

                <div class="sudoku-container">
                    <div id="grid" class="sudoku-grid"></div>
                </div>

                <div id="numpad" class="grid grid-cols-5 gap-2 mt-6"></div>

                <div id="msg" class="hidden mt-4 p-3 rounded-xl text-center font-bold text-sm"></div>

                <div class="flex gap-2 mt-4 items-center">
                    <button id="submit" class="hidden flex-1 bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg">æäº¤æˆç¸¾</button>
                    <button id="admin-btn" class="p-2 text-slate-200">âš™ï¸</button>
                </div>
            </div>
        </main>

        <main id="rank-screen" class="hidden px-2">
            <div class="bg-white p-6 rounded-[2rem] shadow-xl">
                <h2 class="text-xl font-black text-center mb-6">Leaderboard</h2>
                <div class="overflow-hidden rounded-xl border border-slate-50 mb-6">
                    <table class="w-full text-sm text-left">
                        <tbody id="rank-tbody" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
                <button onclick="location.reload()" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold">è¿”å›</button>
            </div>
        </main>
    </div>

    <script>
        const PUZZLE = "00008610006003700000891000401300040000003900004091080000020001720058000800374000";
        const SOLUTION = "479586132162437598538912764913865427687243915254791683345629871726158349891374256";
        let seconds = 0, interval, selected = null, player = {};
        let database = JSON.parse(localStorage.getItem('mossjss_records') || '[]');

        const numDropdown = document.getElementById('num');
        for(let i=1; i<=35; i++) numDropdown.add(new Option(i, i));

        function initGame() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for(let i=0; i<81; i++) {
                const cell = document.createElement('div');
                cell.className = 'sudoku-cell';
                if((i%9) === 2 || (i%9) === 5) cell.classList.add('border-r-thick');
                if(Math.floor(i/9) === 2 || Math.floor(i/9) === 5) cell.classList.add('border-b-thick');

                if(PUZZLE[i] !== '0') {
                    cell.textContent = PUZZLE[i];
                    cell.classList.add('preset');
                } else {
                    cell.onclick = (e) => {
                        e.stopPropagation();
                        if(selected) selected.classList.remove('selected');
                        selected = cell;
                        cell.classList.add('selected');
                    };
                }
                cell.id = `c-${i}`;
                grid.appendChild(cell);
            }

            const pad = document.getElementById('numpad');
            pad.innerHTML = '';
            for(let i=1; i<=9; i++) {
                const b = document.createElement('button');
                b.className = 'numpad-btn';
                b.textContent = i;
                b.onclick = () => fillNumber(i);
                pad.appendChild(b);
            }
            const clr = document.createElement('button');
            clr.className = 'numpad-btn bg-slate-50 text-slate-400';
            clr.innerHTML = 'âŒ«';
            clr.onclick = () => fillNumber("");
            pad.appendChild(clr);
        }

        function fillNumber(num) {
            if(selected && !selected.classList.contains('preset')) {
                selected.textContent = num;
                validate();
            }
        }

        document.addEventListener('keydown', (e) => {
            if(e.key >= 1 && e.key <= 9) fillNumber(e.key);
            if(e.key === "Backspace" || e.key === "0") fillNumber("");
        });

        document.onclick = () => { if(selected) { selected.classList.remove('selected'); selected = null; } };

        function validate() {
            let cur = "";
            for(let i=0; i<81; i++) cur += document.getElementById(`c-${i}`).textContent || "0";
            const msg = document.getElementById('msg');
            if(!cur.includes("0")) {
                if(cur === SOLUTION) {
                    clearInterval(interval);
                    msg.innerHTML = "âœ¨ å®Œæˆï¼å¯ä»¥æäº¤äº†";
                    msg.className = "mt-4 p-3 rounded-xl text-center font-bold bg-green-100 text-green-700 block";
                    document.getElementById('submit').classList.remove('hidden');
                } else {
                    msg.textContent = "âŒ å…§å®¹æœ‰èª¤ï¼Œè«‹æª¢æŸ¥";
                    msg.className = "mt-4 p-3 rounded-xl text-center font-bold bg-red-100 text-red-600 block";
                }
            }
        }

        document.getElementById('reg-form').onsubmit = (e) => {
            e.preventDefault();
            player = {
                name: document.getElementById('name').value.trim(),
                year: document.getElementById('year').value,
                section: document.getElementById('section').value,
                num: document.getElementById('num').value
            };
            document.getElementById('p-name').textContent = player.name;
            initGame();
            document.getElementById('reg-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            interval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds/60).toString().padStart(2,'0');
                const s = (seconds%60).toString().padStart(2,'0');
                document.getElementById('timer-display').textContent = `${m}:${s}`;
            }, 1000);
        };

        document.getElementById('submit').onclick = () => {
            const finalTimeStr = document.getElementById('timer-display').textContent;
            const now = new Date().toLocaleString('zh-TW');
            const formID = "1FAIpQLSfkleuXoAlsbivdiWNYzriMBHcB4HGD_DJYWFvZmTNGvbrKnw";
            const entryIDs = {
                name: "entry.701487326", year: "entry.952790733", section: "entry.1021343510", 
                num: "entry.1352470273", seconds: "entry.1466910873", timeStr: "entry.258411986", timestamp: "entry.1372524630"
            };

            const params = new URLSearchParams();
            Object.keys(entryIDs).forEach(key => {
                let val = player[key] || (key==='seconds'?seconds : key==='timeStr'?finalTimeStr : now);
                params.append(entryIDs[key], val);
            });

            fetch(`https://docs.google.com/forms/d/e/${formID}/formResponse`, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params.toString()
            }).then(() => {
                alert("ğŸ† æˆç¸¾å·²å‚³é€ï¼");
                database.push({ ...player, time_formatted: finalTimeStr, timestamp: now, total_seconds: seconds });
                database.sort((a,b) => a.total_seconds - b.total_seconds);
                localStorage.setItem('mossjss_records', JSON.stringify(database));
                renderRanks();
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('rank-screen').classList.remove('hidden');
            });
        };

        function renderRanks() {
            document.getElementById('rank-tbody').innerHTML = database.slice(0, 10).map(r => `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3"><div class="font-bold text-slate-800">${r.name}</div><div class="text-[10px] text-slate-400">${r.year}${r.section} Â· NO.${r.num}</div></td>
                    <td class="px-4 py-3 text-right"><div class="text-blue-600 font-mono font-black text-lg">${r.time_formatted}</div></td>
                </tr>
            `).join('');
        }

        document.getElementById('goto-rank').onclick = () => { renderRanks(); document.getElementById('reg-screen').classList.add('hidden'); document.getElementById('rank-screen').classList.remove('hidden'); };
        document.getElementById('admin-btn').onclick = () => {
            if(prompt("Admin Password?") === "83745189") {
                for(let i=0; i<81; i++) {
                    const c = document.getElementById(`c-${i}`);
                    if(!c.classList.contains('preset')) c.textContent = SOLUTION[i];
                }
                validate();
            }
        };
    </script>
</body>
</html>
